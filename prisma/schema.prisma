generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// HAOS Database Schema
// 
// Matrix is the source of truth for:
// - Users (Matrix accounts)
// - Servers (Matrix spaces)
// - Channels (Matrix rooms)
// - Messages (Matrix events)
//
// PostgreSQL stores:
// - User profiles/settings (HAOS-specific preferences)
// - Session cache (for performance)
// - Future: search index, analytics, custom features
// =============================================================================

/// User profile with HAOS-specific settings
/// Links to Matrix user via matrixUserId
model Profile {
  id           String  @id @default(uuid())
  matrixUserId String  @unique // e.g., @alice:example.com
  displayName  String?
  avatarUrl    String? // mxc:// URL from Matrix
  email        String?
  
  // HAOS-specific preferences
  settings     Json?   // User preferences as JSON
  theme        String  @default("dark")
  locale       String  @default("en")
  
  // Cached Matrix session (for faster rehydration)
  cachedSession Json?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  serverSettings ServerSettings[]
}

/// Per-server settings for a user
/// Stores things like notification preferences per space
model ServerSettings {
  id            String   @id @default(uuid())
  profileId     String
  profile       Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  matrixSpaceId String   // Matrix space room ID
  
  // Settings
  notifications String   @default("all") // all, mentions, none
  muted         Boolean  @default(false)
  collapsed     Boolean  @default(false) // UI state
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([profileId, matrixSpaceId])
  @@index([profileId])
  @@index([matrixSpaceId])
}

/// Invite codes for servers (HAOS feature)
/// Matrix has its own invite system, but we can add custom codes
model InviteCode {
  id            String   @id @default(uuid())
  code          String   @unique
  matrixSpaceId String   // Matrix space this invite is for
  
  createdBy     String   // Matrix user ID who created it
  maxUses       Int?     // null = unlimited
  uses          Int      @default(0)
  expiresAt     DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([matrixSpaceId])
  @@index([code])
}

/// Audit log for security/compliance
model AuditLog {
  id            String   @id @default(uuid())
  action        String   // e.g., "server.create", "member.kick", "settings.update"
  actorId       String   // Matrix user ID
  targetType    String?  // "user", "server", "channel"
  targetId      String?  // Matrix ID of target
  metadata      Json?    // Additional context
  ipAddress     String?
  
  createdAt     DateTime @default(now())
  
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

// =============================================================================
// Background Job Queue System
// =============================================================================

/// Background job queue for async operations
model Job {
  id            String   @id @default(uuid())
  type          String   // job type: "email", "file-processing", "notification", etc.
  status        String   @default("pending") // pending, processing, completed, failed, cancelled
  priority      Int      @default(0) // higher number = higher priority
  
  // Job data
  payload       Json     // job-specific data
  result        Json?    // job result (on completion)
  error         Json?    // error details (on failure)
  
  // Scheduling
  scheduledAt   DateTime @default(now()) // when job should run
  startedAt     DateTime? // when processing began
  completedAt   DateTime? // when job finished (success or failure)
  
  // Retry logic
  attempts      Int      @default(0)
  maxAttempts   Int      @default(3)
  retryAt       DateTime? // when to retry next (null if no retry scheduled)
  
  // Worker tracking
  workerId      String?  // ID of worker processing this job
  workerPid     Int?     // PID of worker process
  
  // Metadata
  createdBy     String?  // Matrix user ID who created the job
  tags          String[] // for filtering/organization
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  logs          JobLog[]
  
  @@index([status, priority, scheduledAt]) // for job queue queries
  @@index([type, status])                  // for type-specific queries
  @@index([workerId])                      // for worker tracking
  @@index([createdAt])                     // for cleanup/history
  @@index([retryAt])                       // for retry processing
}

/// Job execution log for debugging and analytics
model JobLog {
  id        String   @id @default(uuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  level     String   // "info", "warn", "error", "debug"
  message   String
  metadata  Json?    // additional context
  
  createdAt DateTime @default(now())
  
  @@index([jobId, createdAt])
  @@index([level])
}

/// Worker process registry
model Worker {
  id           String   @id @default(uuid())
  workerId     String   @unique // unique worker identifier
  pid          Int?     // process ID
  hostname     String   // machine hostname
  
  // Worker configuration
  concurrency  Int      @default(1) // how many jobs this worker can handle simultaneously
  jobTypes     String[] // job types this worker can process
  
  // Status
  status       String   @default("active") // active, stopping, stopped, error
  lastHeartbeat DateTime @default(now())
  
  // Statistics
  jobsProcessed Int     @default(0)
  jobsSucceeded Int     @default(0)
  jobsFailed    Int     @default(0)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([workerId])
  @@index([status, lastHeartbeat])
  @@index([hostname])
}
